from google.oauth2 import credentials  # Import credentials from google.oauth2
from google.auth.transport.requests import Request
from googleapiclient.discovery import build
from datetime import datetime

# Define the scope for Google Drive and Google Sheets APIs
SCOPES = [
    'https://www.googleapis.com/auth/drive',
    'https://www.googleapis.com/auth/spreadsheets'
]

# --- Configuration ---
# The name of the starting folder in your Google Drive.
STARTING_FOLDER_NAME = 'crawlsource'
# Email address of the service account to impersonate.
SERVICE_ACCOUNT_EMAIL = 'docsearch@slwardo.iam.gserviceaccount.com'
# Replace with the ID of the Google Sheet you shared with the service account.
# You can find it in the URL of the sheet.
SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID'
# --- End Configuration ---

def list_folder_files_recursive_impersonated(start_folder_name, service_account_email, spreadsheet_id):
    """
    Recursively lists files and folders within a starting Google Drive folder
    and writes their details to a newly created Google Sheet (or overwrites if exists)
    with a dynamic title using service account impersonation.
    """
    try:
        # Define the credentials to be impersonated
        # Use google.oauth2.credentials for impersonation
        creds = credentials.Credentials(
            None,  # No access_token initially
            service_account_email=service_account_email,
            scopes=SCOPES,
            token_uri="https://oauth2.googleapis.com/token",
            subject=service_account_email
        )
        request = Request()
        creds.refresh(request)
        drive_service = build('drive', 'v3', credentials=creds)
        sheets_service = build('sheets', 'v4', credentials=creds)


        # Find the starting folder by name to get its ID for the query
        folder_results = drive_service.files().list(q=f"name='{start_folder_name}' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                                                    fields="files(id, name)").execute()
        start_folders = folder_results.get('files', [])
        if not start_folders:
            print(f"Error: Starting folder '{start_folder_name}' not found.")
            return
        if len(start_folders) > 1:
            print(f"Warning: Multiple folders found with the name '{start_folder_name}'. Processing the first one.")
        start_folder = start_folders[0]
        start_folder_id = start_folder['id']
        parent_folder_name = start_folder['name']  # Use the starting folder's name as parent

        # Generate the spreadsheet title
        now = datetime.now()
        date_str = now.strftime("%Y/%m/%d")
        spreadsheet_title = f"{date_str}-{parent_folder_name}-DocSearch"

        # Check if a spreadsheet with the same title exists
        existing_spreadsheets = drive_service.files().list(q=f"name='{spreadsheet_title}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false",
                                                          fields="files(id)").execute()
        existing_files = existing_spreadsheets.get('files', [])

        spreadsheet_id_to_use = spreadsheet_id  # Use the ID of the sheet you shared

        # Get the name of the first sheet
        spreadsheet = sheets_service.spreadsheets().get(spreadsheetId=spreadsheet_id_to_use).execute()
        sheet_name = spreadsheet.get('sheets', [{}])[0].get('properties', {}).get('title', 'Sheet1')

        # Clear existing content (from row 1 onwards)
        clear_body = {}
        sheets_service.spreadsheets().values().clear(spreadsheetId=spreadsheet_id_to_use, range=f"{sheet_name}!A1:Z", body=clear_body).execute()

        header = ["Folder", "Name", "Date Last Updated", "Size", "URL", "ID", "Description", "Type"]
        value_range_body = {'values': [header]}
        sheets_service.spreadsheets().values().update(spreadsheetId=spreadsheet_id_to_use, range=f"{sheet_name}!A1", valueInputOption='USER_ENTERED', body=value_range_body).execute()

        def process_folder(folder_id, relative_path):
            """Recursively lists files and subfolders and appends to the sheet."""
            try:
                results = drive_service.files().list(q=f"'{folder_id}' in parents and trashed = false",
                                                     fields="files(id, name, mimeType, modifiedTime, size, webViewLink, description)").execute()
                items = results.get('files', [])

                for item in items:
                    item_id = item['id']
                    item_name = item['name']
                    item_type = item['mimeType']
                    modified_time = item.get('modifiedTime', '')
                    size = item.get('size', '')
                    web_view_link = item.get('webViewLink', '')
                    description = item.get('description', '')

                    row_data = [
                        relative_path,
                        item_name,
                        modified_time,
                        size,
                        web_view_link,
                        item_id,
                        description,
                        item_type
                    ]
                    value_range_body = {'values': [row_data]}
                    sheets_service.spreadsheets().values().append(spreadsheetId=spreadsheet_id_to_use, range=sheet_name, valueInputOption='USER_ENTERED', body=value_range_body).execute()

                    if item_type == 'application/vnd.google-apps.folder':
                        process_folder(item_id, f"{relative_path}/{item_name}")

            except Exception as e:
                print(f"An error occurred while processing folder {folder_id}: {e}")

        # Start the recursive processing from the initial folder
        process_folder(start_folder_id, start_folder_name)
        print(f"Successfully listed files and folders from '{start_folder_name}' to spreadsheet with ID '{spreadsheet_id_to_use}' (impersonated).")

    except Exception as e:
        print(f"An error occurred: {e}")

# Example of how to run the function
if __name__ == '__main__':
    # Replace 'YOUR_SPREADSHEET_ID' with the actual ID of the sheet you shared.
    list_folder_files_recursive_impersonated(STARTING_FOLDER_NAME, SERVICE_ACCOUNT_EMAIL, 'YOUR_SPREADSHEET_ID')